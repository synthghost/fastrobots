<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Lab 6: Orientation PID Control &ndash; MAE 4190 Fast Robots</title><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="noindex"><link rel="icon" type="image/png" href="/favicon.png"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Open+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/app.min.css"></head><body class="bg-white dark:bg-gray-950 text-gray-950 dark:text-gray-50 antialiased min-h-full overflow-x-hidden p-0 font-sans text-base leading-relaxed"><div class="mx-auto max-w-[45rem] px-4 sm:px-6"><nav class="flex justify-between mt-10 mb-16"><a class="block bg-brand-600 dark:bg-brand-400 px-2 text-xl sm:text-2xl font-mono font-bold tracking-tightest text-white dark:text-gray-950" href="/">MAE 4190 Fast Robots</a></nav><header class="my-6 space-y-5"><h1 class="text-5xl sm:text-6xl font-display font-bold tracking-tight text-gray-900 dark:text-gray-100">Lab 6: Orientation PID Control</h1><div class="text-gray-500 dark:text-gray-400">March 19, 2024 | 1762 words</div></header><article class="mt-12 prose prose-lg dark:prose-invert prose-headings:font-black prose-headings:tracking-tight"><p>In <a href="https://fastrobotscornell.github.io/FastRobots/labs/Lab6.html">Lab 6</a>, I used IMU yaw measurements to implement a PID controller that points the car toward a particular heading and maintains that orientation.</p><h2>Prelab</h2><p>Much of my preparation for this lab was already in place from <a href="/lab-5-linear-pid-control">Lab 5</a> last week, where I had split up my code by the car's major components and written commands that control those systems via flags. I had also built several tools to help debug my position PID controller via Bluetooth, which I continued to use for orientation control for this lab.</p><p>At the end of <a href="/lab-5-linear-pid-control">Lab 5</a>, I briefly noted an observation I had made about incorrect float encoding in the <code>EString</code> class.</p><blockquote><p>I discovered [...] several odd rounding problems in the <code>EString</code> class. I have not yet had time to investigate this further, but I suspect there may be something wrong with how floats are encoded into BLE messages.</p></blockquote><p>For this lab, I decided to get to the bottom of these problems. It turns out that the version of <code>EString.h</code> we were provided at the beginning of the semester had two significant bugs in how it handled floats and doubles:</p><ol><li>Loss of negative signs for values between 0 and -1. This was found and posted to <a href="https://edstem.org/us/courses/54863/discussion/4558102">Ed Discussion</a> (access restricted) by a classmate of mine.</li><li>Dropping of zeros in the tenths and hundredths places. This was the problem I had observed last week.</li></ol><p>The first problem caused values like <code>-0.25</code> to appear as <code>0.25</code> when sent over BLE. The second turned very small values like <code>0.005</code> into <code>0.5</code> when the "leading" zeros of the decimal part of the float were truncated.</p><p>I devised a fix for the second problem, incorporated a fix for the first as suggested by my classmate, and posted an updated <code>EString.h</code> to <a href="https://edstem.org/us/courses/54863/discussion/4560567">Ed Discussion</a> (access restricted) for others to use. The relevant changes, shown below, apply to the <code>float</code> and <code>double</code> signatures of <code>append()</code>.</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">float</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> integer_part <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> decimal_part <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token function">abs</span><span class="token punctuation">(</span>value <span class="token operator">-</span> integer_part<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//10^3 for 3 decimal places</span>

    <span class="token comment">// Account for negative values</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">strcat</span><span class="token punctuation">(</span>char_array<span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Write absolute integer value</span>
    <span class="token function">append</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>integer_part<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcat</span><span class="token punctuation">(</span>char_array<span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Account for leading zeros</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>decimal_part <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">append</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>decimal_part <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">append</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Write decimal value</span>
    <span class="token function">append</span><span class="token punctuation">(</span>decimal_part<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>With this resolved, I was ready to move on to orientation control.</p><h2>Tasks</h2><h3>Task 1: Orientation Input</h3><p>Much like last week, I decided to use all three terms of a PID controller to implement robust and highly responsive orientation control. The mathematical form for this is the same as for position control, so that</p><p><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg style="vertical-align: -2.063ex;" xmlns="http://www.w3.org/2000/svg" width="39.805ex" height="5.526ex" role="img" focusable="false" viewBox="0 -1530.7 17593.8 2442.6" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-1-TEX-I-1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-1-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-1-TEX-I-1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path><path id="MJX-1-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path id="MJX-1-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-1-TEX-N-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path><path id="MJX-1-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path><path id="MJX-1-TEX-LO-222B" d="M114 -798Q132 -824 165 -824H167Q195 -824 223 -764T275 -600T320 -391T362 -164Q365 -143 367 -133Q439 292 523 655T645 1127Q651 1145 655 1157T672 1201T699 1257T733 1306T777 1346T828 1360Q884 1360 912 1325T944 1245Q944 1220 932 1205T909 1186T887 1183Q866 1183 849 1198T832 1239Q832 1287 885 1296L882 1300Q879 1303 874 1307T866 1313Q851 1323 833 1323Q819 1323 807 1311T775 1255T736 1139T689 936T633 628Q574 293 510 -5T410 -437T355 -629Q278 -862 165 -862Q125 -862 92 -831T55 -746Q55 -711 74 -698T112 -685Q133 -685 150 -700T167 -741Q167 -789 114 -798Z"></path><path id="MJX-1-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-1-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D462" xlink:href="#MJX-1-TEX-I-1D462"></use></g><g data-mml-node="mo" transform="translate(572,0)"><use data-c="28" xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(961,0)"><use data-c="1D461" xlink:href="#MJX-1-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(1322,0)"><use data-c="29" xlink:href="#MJX-1-TEX-N-29"></use></g><g data-mml-node="mo" transform="translate(1988.8,0)"><use data-c="3D" xlink:href="#MJX-1-TEX-N-3D"></use></g><g data-mml-node="msub" transform="translate(3044.6,0)"><g data-mml-node="mi"><use data-c="1D43E" xlink:href="#MJX-1-TEX-I-1D43E"></use></g><g data-mml-node="mi" transform="translate(882,-150) scale(0.707)"><use data-c="1D45D" xlink:href="#MJX-1-TEX-I-1D45D"></use></g></g><g data-mml-node="mi" transform="translate(4332.2,0)"><use data-c="1D452" xlink:href="#MJX-1-TEX-I-1D452"></use></g><g data-mml-node="mo" transform="translate(4798.2,0)"><use data-c="28" xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(5187.2,0)"><use data-c="1D461" xlink:href="#MJX-1-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(5548.2,0)"><use data-c="29" xlink:href="#MJX-1-TEX-N-29"></use></g><g data-mml-node="mo" transform="translate(6159.5,0)"><use data-c="2B" xlink:href="#MJX-1-TEX-N-2B"></use></g><g data-mml-node="msub" transform="translate(7159.7,0)"><g data-mml-node="mi"><use data-c="1D43E" xlink:href="#MJX-1-TEX-I-1D43E"></use></g><g data-mml-node="mi" transform="translate(882,-150) scale(0.707)"><use data-c="1D456" xlink:href="#MJX-1-TEX-I-1D456"></use></g></g><g data-mml-node="msubsup" transform="translate(8502.3,0)"><g data-mml-node="mo" transform="translate(0 1)"><use data-c="222B" xlink:href="#MJX-1-TEX-LO-222B"></use></g><g data-mml-node="mi" transform="translate(1046.4,1088.1) scale(0.707)"><use data-c="1D461" xlink:href="#MJX-1-TEX-I-1D461"></use></g><g data-mml-node="mn" transform="translate(589,-896.4) scale(0.707)"><use data-c="30" xlink:href="#MJX-1-TEX-N-30"></use></g></g><g data-mml-node="mi" transform="translate(10020.6,0)"><use data-c="1D452" xlink:href="#MJX-1-TEX-I-1D452"></use></g><g data-mml-node="mo" transform="translate(10486.6,0)"><use data-c="28" xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(10875.6,0)"><use data-c="1D461" xlink:href="#MJX-1-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(11236.6,0)"><use data-c="29" xlink:href="#MJX-1-TEX-N-29"></use></g><g data-mml-node="mi" transform="translate(11625.6,0)"><use data-c="1D451" xlink:href="#MJX-1-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(12145.6,0)"><use data-c="1D461" xlink:href="#MJX-1-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(12728.8,0)"><use data-c="2B" xlink:href="#MJX-1-TEX-N-2B"></use></g><g data-mml-node="msub" transform="translate(13729.1,0)"><g data-mml-node="mi"><use data-c="1D43E" xlink:href="#MJX-1-TEX-I-1D43E"></use></g><g data-mml-node="mi" transform="translate(882,-150) scale(0.707)"><use data-c="1D451" xlink:href="#MJX-1-TEX-I-1D451"></use></g></g><g data-mml-node="mfrac" transform="translate(15028.8,0)"><g data-mml-node="mrow" transform="translate(220,710)"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-1-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(520,0)"><use data-c="1D452" xlink:href="#MJX-1-TEX-I-1D452"></use></g><g data-mml-node="mo" transform="translate(986,0)"><use data-c="28" xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1375,0)"><use data-c="1D461" xlink:href="#MJX-1-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(1736,0)"><use data-c="29" xlink:href="#MJX-1-TEX-N-29"></use></g></g><g data-mml-node="mrow" transform="translate(842,-686)"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-1-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(520,0)"><use data-c="1D461" xlink:href="#MJX-1-TEX-I-1D461"></use></g></g><rect width="2325" height="60" x="120" y="220"></rect></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>u</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>K</mi><mi>p</mi></msub><mi>e</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mi>K</mi><mi>i</mi></msub><msubsup><mo data-mjx-texclass="OP">âˆ«</mo><mn>0</mn><mi>t</mi></msubsup><mi>e</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mi>d</mi><mi>t</mi><mo>+</mo><msub><mi>K</mi><mi>d</mi></msub><mfrac><mrow><mi>d</mi><mi>e</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></math></mjx-assistive-mml></mjx-container></p><p>except that the error <mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="3.631ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 1605 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-2-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-2-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-2-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-2-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D452" xlink:href="#MJX-2-TEX-I-1D452"></use></g><g data-mml-node="mo" transform="translate(466,0)"><use data-c="28" xlink:href="#MJX-2-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(855,0)"><use data-c="1D461" xlink:href="#MJX-2-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(1216,0)"><use data-c="29" xlink:href="#MJX-2-TEX-N-29"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>e</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></math></mjx-assistive-mml></mjx-container> is now the angular difference between the current orientation and the desired target orientation.</p><p>To measure orientation, specifically about the <mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.052ex" height="1.025ex" role="img" focusable="false" viewBox="0 -442 465 453" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-3-TEX-I-1D467" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D467" xlink:href="#MJX-3-TEX-I-1D467"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>z</mi></math></mjx-assistive-mml></mjx-container> axis, I needed to return my attention to the IMU we played with in <a href="/lab-2-inertial-measurement-unit">Lab 2</a>. However, remembering the significant amount of gyroscope drift I noticed during that lab, I started down something of a rabbit hole to find a robust way to track the car's heading.</p><p>The drift that I can observe in the gyroscope's readings are technically called <em>bias</em>. I'm not completely sure of all the factors that go into it, but bias is essentially an ever-so-slight imbalance in the gyro that yields a steady, erroneous rotational velocity that, when integrated over time, appears as a wandering orientation to the Artemis. Combined with a PID controller, this bias causes the car to slowly chase the erroneous reading at all times.</p><p>Because the bias seemed fairly constant when I tested it in <a href="/lab-2-inertial-measurement-unit">Lab 2</a>, one approach to mitigate drifting orientation could be to collect readings for a period of time, determine the bias velocity, and subtract this from future measurements while running PID control. I wasn't satisfied with this, though, because the approximation involved would still become worse over long run times.</p><p>Some digging into the IMU's datasheet and SparkFun's ICM 20948 <a href="https://github.com/sparkfun/SparkFun_ICM-20948_ArduinoLibrary">Arduino library</a> on GitHub revealed that the bias itself can actually be adjusted with registers. I considered this for a bit but decided to delve further. The datasheet kept mentioning a digital motion processor (DMP) which is included on the IMU board. One note stood out to me:</p><blockquote><p>The DMP enables ultra-low power run-time and <strong>background calibration</strong> of the accelerometer, gyroscope, and compass, <strong>maintaining optimal performance</strong> of the sensor data for both physical and virtual sensors.</p></blockquote><p>The emphasis here is mine. I immediately realized that the DMP unit on the IMU was exactly what I needed to avoid gyroscope drift, yet this feature is <em>disabled by default</em>. Pulling up the Arduino example sketch, <code>Examples &gt; ICM 20948 &gt; Arduino &gt; Example6_DMP_Quat9_Orientation</code>, I inspected the necessary steps to enable the DMP and read orientation data in quaternion form. The sketch also pointed me to a <a href="https://github.com/ZaneL/quaternion_sensor_3d_nodejs">quaternion visualization tool</a> by ZaneL on GitHub. I had to make some updates to the tool to get it working with the latest version of <a href="https://nodejs.org/en">Node.js</a>, but was then able to generate a fun visual of the car's orientation.</p><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/b1g0XmEFRLw?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><p>After playing with the visualization for a while, I learned that the DMP exhibits a bit of drift at first, but then seems to correct for this as it sensor fuses the gyroscope with the accelerometer and compass/magnetometer. After a minute or two, the orientation readings are extremely steady, nothing at all like the wandering mess I saw in Lab 2. Thrilled with this result, I incorporated the DMP initialization routine into the <code>setup()</code> function on my Artemis.</p><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// In setup():</span>
<span class="token keyword">bool</span> success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

success <span class="token operator">&amp;=</span> <span class="token punctuation">(</span>IMU<span class="token punctuation">.</span><span class="token function">initializeDMP</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ICM_20948_Stat_Ok<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Enable the DMP orientation sensor and set to 2000 dps</span>
success <span class="token operator">&amp;=</span> <span class="token punctuation">(</span>IMU<span class="token punctuation">.</span><span class="token function">enableDMPSensor</span><span class="token punctuation">(</span>INV_ICM20948_SENSOR_GAME_ROTATION_VECTOR<span class="token punctuation">)</span> <span class="token operator">==</span> ICM_20948_Stat_Ok<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Configure DMP to output data at maximum ORD</span>
success <span class="token operator">&amp;=</span> <span class="token punctuation">(</span>IMU<span class="token punctuation">.</span><span class="token function">setDMPODRrate</span><span class="token punctuation">(</span>DMP_ODR_Reg_Quat6<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> ICM_20948_Stat_Ok<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Enable the FIFO</span>
success <span class="token operator">&amp;=</span> <span class="token punctuation">(</span>IMU<span class="token punctuation">.</span><span class="token function">enableFIFO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ICM_20948_Stat_Ok<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Enable the DMP</span>
success <span class="token operator">&amp;=</span> <span class="token punctuation">(</span>IMU<span class="token punctuation">.</span><span class="token function">enableDMP</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ICM_20948_Stat_Ok<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Reset DMP</span>
success <span class="token operator">&amp;=</span> <span class="token punctuation">(</span>IMU<span class="token punctuation">.</span><span class="token function">resetDMP</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ICM_20948_Stat_Ok<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Reset FIFO</span>
success <span class="token operator">&amp;=</span> <span class="token punctuation">(</span>IMU<span class="token punctuation">.</span><span class="token function">resetFIFO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ICM_20948_Stat_Ok<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Setting the DMP mode to <code>INV_ICM20948_SENSOR_GAME_ROTATION_VECTOR</code> sets the IMU polling rate to 1.1 kHz and the maximum rotational velocity for the gyroscope to 2000 degrees per second (dps). This should be more than enough for PID control of the sort of maneuvers my car is likely to ever perform.</p><p>I could now take orientation measurements from the DMP as quaternions and convert these to an Euler angle for rotation about the <mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.052ex" height="1.025ex" role="img" focusable="false" viewBox="0 -442 465 453" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-4-TEX-I-1D467" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D467" xlink:href="#MJX-4-TEX-I-1D467"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>z</mi></math></mjx-assistive-mml></mjx-container> axis (yaw). To do this in the BLE control loop, I added a <code>record_dmp_data()</code> function.</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">float</span> yaw_gy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">double</span> qw<span class="token punctuation">;</span>
<span class="token keyword">double</span> qx<span class="token punctuation">;</span>
<span class="token keyword">double</span> qy<span class="token punctuation">;</span>
<span class="token keyword">double</span> qz<span class="token punctuation">;</span>
<span class="token keyword">double</span> siny<span class="token punctuation">;</span>
<span class="token keyword">double</span> cosy<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">record_dmp_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    icm_20948_DMP_data_t dmp<span class="token punctuation">;</span>
    IMU<span class="token punctuation">.</span><span class="token function">readDMPdataFromFIFO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Check if the IMU has data</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>IMU<span class="token punctuation">.</span>status <span class="token operator">!=</span> ICM_20948_Stat_Ok<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>IMU<span class="token punctuation">.</span>status <span class="token operator">!=</span> ICM_20948_Stat_FIFOMoreDataAvail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// Check for Quat6 orientation data</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dmp<span class="token punctuation">.</span>header <span class="token operator">&amp;</span> DMP_header_bitmap_Quat6<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// Scale to +/- 1</span>
    qx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> dmp<span class="token punctuation">.</span>Quat6<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Q1<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1073741824.0</span><span class="token punctuation">;</span> <span class="token comment">// Convert to double. Divide by 2^30</span>
    qy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> dmp<span class="token punctuation">.</span>Quat6<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Q2<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1073741824.0</span><span class="token punctuation">;</span> <span class="token comment">// Convert to double. Divide by 2^30</span>
    qz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> dmp<span class="token punctuation">.</span>Quat6<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>Q3<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1073741824.0</span><span class="token punctuation">;</span> <span class="token comment">// Convert to double. Divide by 2^30</span>

    <span class="token comment">// Start converting quaternion to Euler angles</span>
    qw <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>qx <span class="token operator">*</span> qx<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>qy <span class="token operator">*</span> qy<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>qz <span class="token operator">*</span> qz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Yaw (z-axis rotation)</span>
    siny <span class="token operator">=</span> <span class="token number">2.0</span> <span class="token operator">*</span> <span class="token punctuation">(</span>qw <span class="token operator">*</span> qz <span class="token operator">+</span> qx <span class="token operator">*</span> qy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cosy <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> <span class="token number">2.0</span> <span class="token operator">*</span> <span class="token punctuation">(</span>qy <span class="token operator">*</span> qy <span class="token operator">+</span> qz <span class="token operator">*</span> qz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    yaw_gy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">atan2</span><span class="token punctuation">(</span>siny<span class="token punctuation">,</span> cosy<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180.0</span> <span class="token operator">/</span> PI<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>An added benefit of this quaternion approach is that the resulting yaw value incorporates slight misalignments in the other axes. This is great because I have no way to confirm whether my IMU is attached perfectly level to the car with respect to the ground.</p><h3>Task 2: PID Terms</h3><p>With the orientation measurements well sorted, I implemented the PID controller. This was mostly the same as <a href="/lab-5-linear-pid-control">Lab 5</a>, except that I used readings for yaw instead of distance while adding a <code>pid_ori_control()</code> function.</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">float</span> pid_angle_data<span class="token punctuation">[</span>DATA_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Set by BLE command</span>
<span class="token keyword">float</span> Sc_ori <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> Kp_ori <span class="token operator">=</span> <span class="token number">0.01</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> Ki_ori <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> Kd_ori <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> pid_ori_target <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> pid_ori_recip <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">pid_ori_control</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    last_pid_time <span class="token operator">=</span> current_pid_time<span class="token punctuation">;</span>
    current_pid_time <span class="token operator">=</span> <span class="token function">micros</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1.e6</span><span class="token punctuation">;</span> <span class="token comment">// secs</span>
    pid_dt <span class="token operator">=</span> current_pid_time <span class="token operator">-</span> last_pid_time<span class="token punctuation">;</span>

    last_error <span class="token operator">=</span> current_error<span class="token punctuation">;</span>
    current_error <span class="token operator">=</span> yaw_gy <span class="token operator">-</span> pid_ori_target<span class="token punctuation">;</span>

    <span class="token comment">// Set target reciprocal at 180 degrees offset</span>
    pid_ori_recip <span class="token operator">=</span> pid_ori_target <span class="token operator">-</span> <span class="token punctuation">(</span>pid_ori_target <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">180</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>current_error<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">180.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Prevent sudden jumps in angle when crossing the +/- 180 boundary</span>
        current_error <span class="token operator">+=</span> <span class="token punctuation">(</span>pid_ori_recip <span class="token operator">-</span> yaw_gy<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">abs</span><span class="token punctuation">(</span>pid_ori_recip <span class="token operator">-</span> yaw_gy<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">360.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    P_term <span class="token operator">=</span> Kp_ori <span class="token operator">*</span> current_error<span class="token punctuation">;</span>

    error_integral <span class="token operator">=</span> error_integral <span class="token operator">+</span> current_error <span class="token operator">*</span> pid_dt<span class="token punctuation">;</span>
    I_term <span class="token operator">=</span> Ki_ori <span class="token operator">*</span> error_integral<span class="token punctuation">;</span>

    D_term <span class="token operator">=</span> Kd_ori <span class="token operator">*</span> <span class="token punctuation">(</span>current_error <span class="token operator">-</span> last_error<span class="token punctuation">)</span> <span class="token operator">/</span> pid_dt<span class="token punctuation">;</span>

    last_filtered_D_term <span class="token operator">=</span> filtered_D_term<span class="token punctuation">;</span>
    filtered_D_term <span class="token operator">=</span> D_LPF_ALPHA <span class="token operator">*</span> D_term <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>D_LPF_ALPHA<span class="token punctuation">)</span> <span class="token operator">*</span> last_filtered_D_term<span class="token punctuation">;</span>

    speed <span class="token operator">=</span> Sc_ori <span class="token operator">*</span> <span class="token punctuation">(</span>P_term <span class="token operator">+</span> I_term <span class="token operator">+</span> filtered_D_term<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag_record_pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pid_time_data<span class="token punctuation">[</span>pid_data_i<span class="token punctuation">]</span> <span class="token operator">=</span> current_pid_time<span class="token punctuation">;</span>
        pid_angle_data<span class="token punctuation">[</span>pid_data_i<span class="token punctuation">]</span> <span class="token operator">=</span> yaw_gy<span class="token punctuation">;</span>
        pid_p_data<span class="token punctuation">[</span>pid_data_i<span class="token punctuation">]</span> <span class="token operator">=</span> P_term<span class="token punctuation">;</span>
        pid_i_data<span class="token punctuation">[</span>pid_data_i<span class="token punctuation">]</span> <span class="token operator">=</span> I_term<span class="token punctuation">;</span>
        pid_d_data<span class="token punctuation">[</span>pid_data_i<span class="token punctuation">]</span> <span class="token operator">=</span> D_term<span class="token punctuation">;</span>
        pid_df_data<span class="token punctuation">[</span>pid_data_i<span class="token punctuation">]</span> <span class="token operator">=</span> filtered_D_term<span class="token punctuation">;</span>

        pid_data_i<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid_data_i <span class="token operator">&gt;=</span> DATA_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            flag_record_tof <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            flag_record_pid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag_enable_motors<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span> <span class="token operator">&lt;</span> ORIENT_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">stopMotors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Invert speeds for differential steering</span>
    <span class="token function">driveMotors</span><span class="token punctuation">(</span>speed<span class="token punctuation">,</span> <span class="token operator">-</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>For the D (derivative) term, it would normally be inefficient to take the derivative of a yaw value integrated over time from the gyroscope's angular velocity data. But because the DMP provides me with discrete angle readings, I do indeed have to take the derivatives of these.</p><p>As with the position controller in <a href="/lab-5-linear-pid-control">Lab 5</a>, I found it absolutely necessary to add a heavy low-pass filter (LPF) for the derivative term to avoid sending outlandish values to the motor controllers. The plot below shows the effect.</p><img alt="PID filtered D term" src="/img/lab6_derivative_filter.png" width="1000" height="400"><p>When I considered derivative kick in <a href="/lab-5-linear-pid-control">Lab 5</a>, I concluded that my significant LPF was enough to dampen any such behavior. This time, I added kick protection to test it directly. To do this, I changed the PID controller to find the D term from the derivative of the yaw reading rather than the error.</p><pre class="language-diff-cpp"><code class="language-diff-cpp"><span class="token unchanged language-cpp"><span class="token prefix unchanged"> </span>D_term <span class="token operator">=</span> Kd_ori <span class="token operator">*</span> <span class="token punctuation">(</span>current_error <span class="token operator">-</span> last_error<span class="token punctuation">)</span> <span class="token operator">/</span> pid_dt<span class="token punctuation">;</span>
</span><span class="token diff bold language-cpp"><span class="token prefix diff">!</span>D_term <span class="token operator">=</span> Kd_ori <span class="token operator">*</span> <span class="token punctuation">(</span>yaw_gy <span class="token operator">-</span> last_yaw_gy<span class="token punctuation">)</span> <span class="token operator">/</span> pid_dt<span class="token punctuation">;</span>
</span></code></pre><p>This way, changing the setpoint on the fly wouldn't send a large spike through to the motor controllers. However, in practice, I found exactly what I had predicted last week to be true: the LPF cuts down on the spikes so dramatically, that the kick protection does very little to change the behavior of the car.</p><h3>Task 3: Implementation</h3><p>After many experiments and adjustments, my tuned position PID controller now has the following gains:</p><ul><li><code>Kp</code> of 0.4</li><li><code>Ki</code> of 0.08</li><li><code>Kd</code> of 0.6</li></ul><p>Disturbing the car from its resting setpoint causes it to snap back fairly quickly. I used a wooden table for the demos in this lab because after I taped my car's wheels to help it overcome friction for turning, my flooring turned out to be a bit <em>too</em> slippery, so I needed a slightly rougher surface. There is still some overshoot due to slip, however.</p><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/s3oEbs1Gxkk?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><img alt="PID control for disturbance" src="/img/lab6_disturbance.png" width="1000" height="600"><p>As in <a href="/lab-5-linear-pid-control">Lab 5</a>, I kept the implementation for this lab strictly flag-based. That way, I can selectively enable various components and systems on my car, and update PID gains and such, all on the fly. A particularly useful consequence of this is that I can update the orientation setpoint while the PID controller is running. The video below shows targets of 0, 90, and -90 degrees from the initial state.</p><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/uPNz99vw_rs?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><img alt="PID control for setpoint change" src="/img/lab6_setpoint_change.png" width="1000" height="600"><p>While the combination of position and orientation control were not expected in this lab, I did start to think a out how this might work in the future. The car would need to be driving, say, forward with an orientation setpoint of 0 degrees. That alone should yield a straight trajectory. Then, a new orientation setpoint would be sent over BLE and the PID controller would respond to this by adjusting the speed of each motor relative to the active forward input.</p><p>Depending on the amount of change in the setpoint, the speed adjustment for simultaneous position and orientation control may be small, resulting in a curved path, or large, resulting in a considerable turn followed by a straight path in a new direction. Either way, the PID controller needs to make relative adjustments, unlike these last two labs where the adjustments were absolute and not a function of previous inputs.</p><h3>Optional 5000-Level: Wind-Up Protection</h3><p>Just like in <a href="/lab-5-linear-pid-control">Lab 5</a>, I implemented integrator wind-up protection by limiting the error integration to a maximum of 300% speed. This protection was active for all the demos above.</p><pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INTEGRAL_THRESHOLD</span> <span class="token expression"><span class="token number">300</span></span></span>

<span class="token keyword">void</span> <span class="token function">pid_ori_control</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Constrained integral of error</span>
    error_integral <span class="token operator">=</span> <span class="token function">constrain</span><span class="token punctuation">(</span>
        error_integral <span class="token operator">+</span> current_error <span class="token operator">*</span> pid_dt<span class="token punctuation">,</span>
        <span class="token operator">-</span>INTEGRAL_THRESHOLD<span class="token punctuation">,</span> INTEGRAL_THRESHOLD
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre><p>Without this protection, the car would spin wildly out of control as small errors grow into oblivion. What little I saw of this consequence in my testing makes me uncomfortable forcing the behavior for the sake of a demo, so let's just agree that wind-up protection is a good idea.</p><p>An alternative method for dealing with wind-up might be to integrate error over only a finite window of recent time, as opposed to all time as I do currently. This would require a more complex data storage solution, however, which would take more memory and slow down the PID controller.</p><h2>Conclusion</h2><p>This lab, although quite similar in structure to the last one, gave me an opportunity to get much better acquainted with the IMU and its capabilities. If not for my frustration over the gyroscope drift earlier in the semester, I likely would not have figured out how to use the DMP and significantly improved my car's sense of orientation at this point in the project.</p><p>Similarly, had I not been annoyed at the odd float encoding issues I saw when sending data over BLE last week, I would not have found the bugs in <code>EString</code>, the fixes to which I can only hope will benefit my classmates and future students in the course.</p></article><footer class="mt-20 mb-10 sm:flex justify-between text-base/7 text-center text-gray-400 dark:text-gray-600"><p>MAE 4190 Fast Robots at Cornell University</p><p>Â© Spring 2024</p></footer></div></body></html>