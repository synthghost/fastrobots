<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Lab 3: Time of Flight &ndash; MAE 4190 Fast Robots</title><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="noindex"><link rel="icon" type="image/png" href="/favicon.png"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Open+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/app.min.css"></head><body class="bg-white dark:bg-gray-950 text-gray-950 dark:text-gray-50 antialiased min-h-full overflow-x-hidden p-0 font-sans text-base leading-relaxed"><div class="mx-auto max-w-[45rem] px-4 sm:px-6"><nav class="flex justify-between mt-10 mb-16"><a class="block bg-brand-600 dark:bg-brand-400 px-2 text-xl sm:text-2xl font-mono font-bold tracking-tightest text-white dark:text-gray-950" href="/">MAE 4190 Fast Robots</a></nav><header class="my-6 space-y-5"><h1 class="text-5xl sm:text-6xl font-display font-bold tracking-tight text-gray-900 dark:text-gray-100">Lab 3: Time of Flight</h1><div class="text-gray-500 dark:text-gray-400">February 20, 2024 | 1481 words</div></header><article class="mt-12 prose prose-lg dark:prose-invert prose-headings:font-black prose-headings:tracking-tight"><p>In <a href="https://fastrobotscornell.github.io/FastRobots/labs/Lab3.html">Lab 3</a>, I added a battery and two VL53L1X Time-of-Flight (ToF) sensors to the Artemis, then tested the sensors' capabilities, range, and accuracy.</p><h2>Prelab</h2><p>I started by planning out how to use two <a href="https://www.pololu.com/product/3415">Pololu VL53L1X ToF sensors</a> with my Artemis through a <a href="https://www.sparkfun.com/products/18012">Qwiic MultiPort</a> connector. Looking over the <a href="https://cdn.sparkfun.com/assets/8/9/9/a/6/VL53L0X_DS.pdf">datasheet</a>, I noticed that the default I<sup>2</sup>C address of the VL53L1X sensors is <code>0x52</code>.</p><p>Because the ToF sensors have the same default I<sup>2</sup>C address, communicating with two of them simultaneously will require a change of address routine. My approach for this will be to use the <code>XSHUT</code> pin of one of the two sensors to disable it temporarily, while sending an address change command over I<sup>2</sup>C to the other. I will need to wire the <code>XSHUT</code> pin to one of the Artemis GPIO pins to control the sensor state programmatically. Alternatively, I could wire the <code>XSHUT</code> pin of both sensors, but I believe this is unnecessary because I can leave the second sensor disabled until I'm sure the first address is changed.</p><p>With the provided lengths of I<sup>2</sup>C cables bridged by the Qwiic MultiPort, I can place the ToF sensors just about anywhere on the 6-inch-long body of the robot. I anticipate that placing the two sensors on opposite ends of the car—one facing forward, one facing backward—will be most useful for future labs. A side-mounted sensor could also be desireable to detect obstacles next to the robot, but this is only true if the obstacle happens to be on the same side as the sensor. In the end, I'll have to stop and spin the car to sense in 360 degrees anyway. So, for now, I stand by my forward- and rear-facing ToF placements.</p><p>When wiring the ToF sensors, I will have to make the I<sup>2</sup>C connections to the sensors permanent because there are no Qwiic connectors on the ToF boards. The <code>XSHUT</code> connection will also need to be permanent because the Artemis GPIO pins are really just soldering pads. The remaining connections—the battery JST and all Qwiic ports—can stay detachable, which may prove useful when finalizing the arrangement of components on the robot. When placing the ToF sensors, the emitter modules will need to face outward, so the soldered wires should protrude from the backs of the boards.</p><img alt="Artemis wiring diagram" src="/img/lab3_wiring.jpg" width="1400" height="716"><h2>Tasks</h2><h3>Task 1: Battery Power</h3><p>Someday soon, my Artemis and its sensors will be attached to the RC car without a tether to my Mac. To prepare for this, I soldered a JST connector to a 3.7 V battery and used it to power the Artemis sans USB cable. I then used the <code>ECHO</code> command from <a href="/lab-1b-bluetooth">Lab 1</a> to check the BLE connection.</p><aside class="text-base text-black dark:text-white px-7 py-6 space-y-5 border-l-4 rounded-md bg-blue-400/15 border-blue-400"><p><strong>Note:</strong> The photo and video below show the Artemis with a battery and a ToF sensor because I captured the imagery after soldering on a permanent connection between one of the <code>XSHUT</code> pins and the Artemis for a later task.</p></aside><p></p><img alt="Artemis powered by battery" src="/img/lab3_battery.jpg" width="1400" height="894"><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/FCk5P-uwnOU?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><h3>Task 2: ToF Connections</h3><p>To connect the ToF sensors to the Artemis, I soldered a long Qwiic cable to the contacts on each of the ToF boards, such that:</p><ul><li><code>VIN</code> → red wire</li><li><code>GND</code> → black wire</li><li><code>SDA</code> → blue wire</li><li><code>SCL</code> → yellow wire</li></ul><img alt="ToF connected to Artemis" src="/img/lab3_tof_connected.jpg" width="1400" height="794"> <img alt="Soldered ToF pins" src="/img/lab3_tof_pins.jpg" width="1400" height="830"><h3>Task 3: I<sup>2</sup>C Scanning</h3><p>With the first ToF sensor connected, I scanned for I<sup>2</sup>C addresses using the example sketch <code>Apollo3 &gt; Example05_Wire_I2C</code>.</p><img alt="Arduino IDE I2C scan" src="/img/lab3_i2c_scan.png" width="1400" height="909"><p>Based on the datasheet, I had expected the ToF sensor to respond to an address of <code>0x52</code> (82), but the scan yielded <code>0x29</code> (41). This is because the least significant bit of the address packet is used for read/write direction status of the I<sup>2</sup>C interface. When represented without this last bit, as in the scan above, the remaining address is bit shifted to the right (<code>0b1010010</code> → <code>0b0101001</code>), an operation equivalent to halving the decimal value.</p><h3>Task 4: Sensing Modes</h3><p>I installed the latest version of the <a href="https://github.com/sparkfun/SparkFun_VL53L1X_Arduino_Library">SparkFun VL53L1X Arduino library</a>, which supports two modes for sensing distance: <em>short</em> and <em>long</em>. The long mode can measure up to 4 meters but is disturbed by strong ambient light at large distances, while the short mode is less susceptible to ambient light but can only measure up to roughly 1.3 meters. The tradeoff here is between range and lighting conditions.</p><p>Since we will be operating our robot at various times of day and in different types of artificial lighting in the lab or at home, greater sensor reliability in ambient light via the <strong>short mode</strong> is the better choice. The robot may not be able to see as far, but when trying to avoid obstacles, it's the short distances that will likely matter more.</p><p>Using the example sketch <code>SparkFun VL53L1X &gt; Example1_ReadDistance</code>, and setting the sensor mode with <code>setDistanceModeShort()</code>, I collected ToF sensor readings for a variety of distances.</p><img alt="Arduino serial monitor of short mode ToF data" src="/img/lab3_short_mode.png" width="1400" height="909"><p>I then calculated the mean, absolute error, and standard deviation for the data taken at each distance. The absolute error—defined as the difference between actual distance and mean reading—yields the accuracy of the sensor, while the standard deviation informs the repeatability of measurements.</p><img alt="Plots of ToF readings and actual distances" src="/img/lab3_distances.png" width="1200" height="500"><p>Based on the trends in the plot above, the sensor is not terribly accurate nor reliable at very close distances. This confirms the minimum bound of 4 cm in the datasheet. In fact, a practical lower limit of 10 cm might be advisable. At larger distances well within the short mode range, the sensor has fairly low error at around <strong>4 mm</strong> and good repeatability at around <strong>1.1 mm</strong>.</p><p>Next, I collected readings over a larger range of distances to test the upper limits of the ToF sensor in short mode.</p><img alt="Plots of functional ToF range" src="/img/lab3_range.png" width="1200" height="500"><p>This plot shows that error starts to rise dramatically past about <strong>1.2 meters</strong>, which is again consistent with the maximum specification of 1.3 meters for short mode in the datasheet. The sensor will give roughly valid readings beyond that bound, but these should not be trusted as accurate.</p><p>To determine the effects of ranging time, I collected measurements for several timing budgets at each of three distances. Plotting the results, the trends indicate that higher timing budgets are more accurate and repeatable, but this comes at a cost of increased impact on the maximum control loop speed.</p><img alt="Plots of ToF timing budget effects" src="/img/lab3_budgets.png" width="1200" height="500"><h3>Task 5: Parallel Sensors</h3><p>With one ToF sensor working, I connected the second sensor and additionally soldered a connection between the sensor's <code>XSHUT</code> pin and GPIO pin <code>2</code> on my Artemis. I then added logic to my <code>setup()</code> function to initialize the two sensors sequentially while setting a non-default address of <code>0x48</code> on the first.</p><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Shutdown pin and address for ToF1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">XSHUT_PIN</span> <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TOF1_ADDRESS</span> <span class="token expression"><span class="token number">0x48</span></span></span>

SFEVL53L1X TOF1<span class="token punctuation">;</span>
SFEVL53L1X TOF2<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Turn off ToF2</span>
    <span class="token function">digitalWrite</span><span class="token punctuation">(</span>XSHUT_PIN<span class="token punctuation">,</span> LOW<span class="token punctuation">)</span><span class="token punctuation">;</span>

    TOF1<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Try an address change. This either succeeds, or it</span>
    <span class="token comment">// fails because the sensor remembered its old address.</span>
    <span class="token comment">// Either way, the address is correct and we can move on.</span>
    TOF1<span class="token punctuation">.</span><span class="token function">setI2CAddress</span><span class="token punctuation">(</span>TOF1_ADDRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>TOF1<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Sensor 1 failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Turn on ToF2</span>
    <span class="token function">digitalWrite</span><span class="token punctuation">(</span>XSHUT_PIN<span class="token punctuation">,</span> HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>TOF2<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Sensor 2 failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>That done, I was able to measure distances from both sensors simultaneously.</p><img alt="Arduino serial monitor of both ToF sensors" src="/img/lab3_two_tof.png" width="1400" height="909"><h3>Task 6: Sensing Speed</h3><p>To quantify the speed of the ToF sensors, I changed my <code>loop()</code> function to print the current program time to the serial monitor as quickly as possible and add in the sensor readings whenever they're ready. I also added flags and conditions to enable sensor ranging only when needed.</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token function">micros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Start ToF1 ranging if not already active</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag_TOF1_ranging<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        TOF1<span class="token punctuation">.</span><span class="token function">startRanging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        flag_TOF1_ranging <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Start ToF2 ranging if not already active</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag_TOF2_ranging<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        TOF2<span class="token punctuation">.</span><span class="token function">startRanging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        flag_TOF2_ranging <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Print ToF1 distance when ready</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag_TOF1_ranging <span class="token operator">&amp;&amp;</span> TOF1<span class="token punctuation">.</span><span class="token function">checkForDataReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>TOF1<span class="token punctuation">.</span><span class="token function">getDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TOF1<span class="token punctuation">.</span><span class="token function">clearInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TOF1<span class="token punctuation">.</span><span class="token function">stopRanging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Print ToF2 distance when ready</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag_TOF2_ranging <span class="token operator">&amp;&amp;</span> TOF2<span class="token punctuation">.</span><span class="token function">checkForDataReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>TOF2<span class="token punctuation">.</span><span class="token function">getDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TOF2<span class="token punctuation">.</span><span class="token function">clearInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TOF2<span class="token punctuation">.</span><span class="token function">stopRanging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Running the above for a few seconds showed that program times can be printed every <strong>4.3 ms</strong> or so, but that the interval between sensor readings is closer to <strong>103 ms</strong>. This suggests a printing rate of 233 Hz and a distance sensing rate of only 9.7 Hz. The limiting factor here is clearly the ToF sensors, which can only be read when data is ready. That said, the sensors are advertised for 50 Hz, yet the Artemis is unable to achieve that rate. This may be explained by delays introduced by C++ function calls, or perhaps some implementation factors in the SparkFun VL53L1X library, or even the ToF sensors' ranging times.</p><img alt="Plot of Artemis loop timing" src="/img/lab3_timing.png" width="1200" height="500"><h3>Task 7: Bluetooth</h3><p>The last of my tasks was to incorporate the ToF data into the Bluetooth transfer system I've developed over the last few labs. To do this, I added two more flag-managing commands to the Artemis, <code>START_TOF_DATA</code> and <code>STOP_TOF_DATA</code>.</p><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// In handle_command():</span>
<span class="token keyword">case</span> START_TOF_DATA<span class="token operator">:</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Recording TOF data..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">digitalWrite</span><span class="token punctuation">(</span>LED_BUILTIN<span class="token punctuation">,</span> HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    flag_record_tof <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

<span class="token keyword">case</span> STOP_TOF_DATA<span class="token operator">:</span>
    flag_record_tof <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">digitalWrite</span><span class="token punctuation">(</span>LED_BUILTIN<span class="token punctuation">,</span> LOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Stopped recording TOF data."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span></code></pre><p>I then called <code>SEND_TOF_DATA</code> in Python and plotted the distances over time.</p><img alt="Plot of ToF data over Bluetooth" src="/img/lab3_tof_data.png" width="1000" height="400"><h3>Optional 5000-Level: Other Sensors</h3><p>Infrared-based distance sensors generally all operate by emitting infrared waves and detecting the reflections. Whereas ToF sensors use time or phase differences to calculate the distance traveled by a laser pulse, so-called "IR" distance sensors measure the angle of reflection to triangulate distances. Both ToF and IR sensors are very common and low in cost. Another type of distance sensor in the infrared family is LIDAR, which also operates on a laser-pulse timing principle, but is far more precise and therefore much more expensive.</p><h3>Optional 5000-Level: Color and Texture</h3><p>The ToF sensors seem to operate fairly consistently when sensing objects of different textures and colors. Color was a straightforward variable to test systematically, so I took various ToF measurements and plotted the results. Both the accuracy and reliability are within the norm found earlier.</p><img alt="Plot of ToF data for different colors" src="/img/lab3_colors.png" width="1200" height="500"><h2>Conclusion</h2><p>This lab has had me thinking about how limited our robots' ability to see their environments will be. Even with two ToF sensors, the cars will need to spend a good deal of time scanning objects in their vicinity by spinning in circles and collecting distance information. By scanning, we could then build a map in the robot's memory with which to, for example, navigate to a target objective.</p></article><footer class="mt-20 mb-10 sm:flex justify-between text-base/7 text-center text-gray-400 dark:text-gray-600"><p>MAE 4190 Fast Robots at Cornell University</p><p>© Spring 2024</p></footer></div></body></html>