<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Lab 8: Stunts &ndash; MAE 4190 Fast Robots</title><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="noindex"><link rel="icon" type="image/png" href="/favicon.png"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Open+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/app.min.css?v=dfc83a03"></head><body class="bg-white dark:bg-gray-950 text-gray-950 dark:text-gray-50 antialiased min-h-full overflow-x-hidden p-0 font-sans text-base leading-relaxed"><div class="mx-auto max-w-[45rem] px-4 sm:px-6"><nav class="flex justify-between mt-10 mb-16"><a class="block bg-brand-600 dark:bg-brand-400 px-2 text-xl sm:text-2xl font-mono font-bold tracking-tightest text-white dark:text-gray-950" href="/">MAE 4190 Fast Robots</a></nav><header class="my-6 space-y-5"><h1 class="text-5xl sm:text-6xl font-display font-bold tracking-tight text-gray-900 dark:text-gray-100">Lab 8: Stunts</h1><div class="text-gray-500 dark:text-gray-400">April 9, 2024 | 754 words</div></header><article class="mt-12 prose prose-lg dark:prose-invert prose-headings:font-black prose-headings:tracking-tight"><p>In <a href="https://fastrobotscornell.github.io/FastRobots/labs/Lab8.html">Lab 8</a>, I used distance measurements and orientation control to have my car perform a drift in the form of a 180 degree turn after running at a wall.</p><h2>Orientation Control</h2><p>I chose an orientation-based stunt, mostly because I think the mechanism involved is more interesting, but also because I know orientation control will continue to matter significantly in upcoming labs, so this was a good chance to improve upon my implementation from <a href="/lab-6-orientation-pid-control">Lab 6</a>.</p><h3>Straight and Narrow</h3><p>To prepare for a drift maneuver, I first wanted to combine linear movement with orientation control, thereby allowing my car to drive in a straight line while approaching a wall. This only required a minor addition to my orientation PID controller: a base speed.</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">pidOriControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// The total magnitude of motor input should exceed the threshold</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>ori_base_speed<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">abs</span><span class="token punctuation">(</span>input_speed<span class="token punctuation">)</span> <span class="token operator">&lt;</span> ORIENT_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">idleMotors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Drive the motors relative to the base speed</span>
    <span class="token function">driveMotors</span><span class="token punctuation">(</span>ori_base_speed <span class="token operator">+</span> input_speed<span class="token punctuation">,</span> ori_base_speed <span class="token operator">-</span> input_speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>The base speed generates the car's linear movement, while the PID controller's input speed acts as a correction term. This way, setting a constant angular heading and driving the car forward should propel it perfectly straight, or at least more so than I was able to achieve with motor calibration alone in <a href="/lab-4-motors-and-open-loop-control">Lab 4</a>.</p><h3>A Wrinkle In Time</h3><p>While testing the straight-line mechanism and trying to prepare for a 180 degree turn by measuring the distance ahead of the car, I ran into a significant problem with my IMU.</p><p>While working on <a href="/lab-6-orientation-pid-control">Lab 6</a>, I had starting using the DMP feature of the IMU breakout board. This had worked really well for orientation control only two weeks earlier. However, now that I had a base speed and multiple sensors going at the same time, the DMP starting acting up in a particularly nasty way. Its readings would slow down and lag behind physical reality over the course of thirty seconds or so, before finally giving out entirely, sending my orientation PID controller into a tailspin.</p><p>I tried to fix the issue for several days but made no real progress in identifying the root cause. At first, it seemed hardware might be to blame. I tried re-soldering several of my connections. I tried replacing wires, Qwiic connections, and battery cables. I even tried replacing the IMU and testing with a different Artemis. What was most strange is that nothing ever seemed wrong when running the IMU in isolation or with one or two other systems active. It was only when all cylinders were firing at once, so to speak, that the DMP would go absolutely bananas.</p><p>At some point, while reading through documentation and examples, I noticed that the DMP materials make a few references to functions with "FIFO" in their name. I had seen this some weeks earlier but not given it much thought. It suddenly hit me that "FIFO" here meant "first in, first out", the directionality moniker for queues.</p><p>The problem that had, at this point, plagued me for nearly a week became clear in an instant. Somehow, the DMP must be storing its readings in an internal queue on the chip, waiting to be read off over I<sup>2</sup>C. The trouble with that is, because the DMP measures orientation so quickly and I only ever read one value at a time after performing a readiness check, I had been inadvertently letting the chip's buffer fill up. This is what caused both the lagging behavior and the crashes I had been observing. And the reason this clogging of the DMP happened just when all my sensors and systems were running is because only the sum total of all those processes slowed the main control loop down enough to dip below the sampling rate of the DMP.</p><p>The fix for all this wasn't anything to do with my hardware, or my PID controller, or the BLE connection, or any of the several other things I tried; it was simply to slow the DMP down so that my Artemis could catch up with it. Once I did that, orientation control was back in business.</p><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Configuring DMP to output data at multiple ODRs: DMP is capable</span>
<span class="token comment">// of outputting multiple sensor data at different rates to FIFO.</span>
<span class="token comment">// Setting value can be calculated as follows:</span>
<span class="token comment">// Value = (DMP running rate / ODR ) - 1</span>
IMU<span class="token punctuation">.</span><span class="token function">setDMPODRrate</span><span class="token punctuation">(</span>DMP_ODR_Reg_Quat6<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Set to half speed</span></code></pre><h3>Drifting Away</h3><p>With a now working orientation controller, I added a <code>DRIFT</code> Python command and proceeded to run my car across my kitchen in spectacular Hollywood fashion. The results of these stunts are shown as videos and plots below.</p><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/QhGHgIk_Cp0?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><img alt="Drift trial 1 data" src="/img/lab8_drift_1.png" width="1000" height="500"><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/DnQeZ7v2p-k?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><img alt="Drift trial 2 data" src="/img/lab8_drift_2.png" width="1000" height="500"><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/IcJGVk-SrjI?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><img alt="Drift trial 3 data" src="/img/lab8_drift_3.png" width="1000" height="500"><h2>Conclusion</h2><p>This was supposed to be a quick and fun lab to show off some of my car's new capabilities. It turned into a multi-hour debugging ordeal that all stemmed from my stubborn insistence on using the DMP. That said, I think it was worth it. The DMP is so much better than integrating the raw gyroscope readings that it was good to improve my understanding of it, albeit painfully.</p></article><footer class="mt-20 mb-10 sm:flex justify-between text-base/7 text-center text-gray-400 dark:text-gray-600"><p>MAE 4190 Fast Robots at Cornell University</p><p>Â© Spring 2024</p></footer></div></body></html>