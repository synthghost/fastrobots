<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Lab 11: Real Localization &ndash; MAE 4190 Fast Robots</title><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="noindex"><link rel="icon" type="image/png" href="/favicon.png"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Open+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/app.min.css?v=536584b4"></head><body class="bg-white dark:bg-gray-950 text-gray-950 dark:text-gray-50 antialiased min-h-full overflow-x-hidden p-0 font-sans text-base leading-relaxed"><div class="mx-auto max-w-[45rem] px-4 sm:px-6"><nav class="flex justify-between mt-10 mb-16"><a class="block bg-brand-600 dark:bg-brand-400 px-2 text-xl sm:text-2xl font-mono font-bold tracking-tightest text-white dark:text-gray-950" href="/">MAE 4190 Fast Robots</a></nav><header class="my-6 space-y-5"><h1 class="text-5xl sm:text-6xl font-display font-bold tracking-tight text-gray-900 dark:text-gray-100">Lab 11: Real Localization</h1><div class="text-gray-500 dark:text-gray-400">April 30, 2024</div></header><article class="mt-12 prose prose-lg dark:prose-invert prose-headings:font-black prose-headings:tracking-tight"><p>In <a href="https://fastrobotscornell.github.io/FastRobots/labs/Lab11.html">Lab 11</a>, I used the orientation mapping system from Lab 9 and the Bayes filter from Lab 10 to localize the real car in our lab arena.</p><h2>Simulation</h2><p>I started the lab by verifying my simulated localization solution from <a href="/lab-10-simulated-localization">Lab 10</a> by running <code>lab11_sim.ipynb</code>, one of the provided <a href="https://github.com/CEI-lab/FastRobots-lab11">Lab 11 notebooks</a>. The image below shows the results of the Lab 11 simulation.</p><img alt="Localization simulation" src="/img/lab11_simulation.png" width="1400" height="966"><p>This looks quite similar to what I saw in Lab 10, the video from which is included below for reference. The Lab 11 version took 1:31 to run, while my Lab 10 solution took 1:33. I'd say that's well verified.</p><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/zWh_xxYJSaQ?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><h2>Reality</h2><p>For now, because we don't have a mechanism to determine the ground truth of the car, I implemented only the update step of the Bayes filter with the method <code>perform_observation_loop()</code> in the provided <code>RealRobot</code> class. The method uses BLE to command the car to spin in a circle and scan the map in 20 degree increments, reusing the <code>DO_MAPPING</code> Artemis routine I wrote in <a href="/lab-9-mapping">Lab 9</a>.</p><pre class="language-py"><code class="language-py"><span class="token comment"># In RealRobot:</span>
<span class="token keyword">def</span> <span class="token function">perform_observation_loop</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rot_vel<span class="token operator">=</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    increment <span class="token operator">=</span> <span class="token number">360</span> <span class="token operator">//</span> self<span class="token punctuation">.</span>num_steps
    error <span class="token operator">=</span> <span class="token number">3</span>
    readings <span class="token operator">=</span> <span class="token number">5</span>

    self<span class="token punctuation">.</span>nano<span class="token punctuation">.</span>command<span class="token punctuation">(</span>CMD<span class="token punctuation">.</span>DO_MAPPING<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>increment<span class="token punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">{</span>error<span class="token punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">{</span>readings<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    LOG<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Observing...'</span><span class="token punctuation">)</span>

    <span class="token comment"># Wait for the command to finish</span>
    duration <span class="token operator">=</span> self<span class="token punctuation">.</span>nano<span class="token punctuation">.</span>await_end<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>

    LOG<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Finished observing in: </span><span class="token interpolation"><span class="token punctuation">{</span>duration<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    LOG<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Receiving data...'</span><span class="token punctuation">)</span>

    self<span class="token punctuation">.</span>nano<span class="token punctuation">.</span>command<span class="token punctuation">(</span>CMD<span class="token punctuation">.</span>SEND_SENSOR_DATA<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>nano<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token string">'Tu'</span><span class="token punctuation">)</span>

    LOG<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Finished receiving data.'</span><span class="token punctuation">)</span>

    data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>k<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> row<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> self<span class="token punctuation">.</span>nano<span class="token punctuation">.</span>data<span class="token punctuation">]</span>
    run <span class="token operator">=</span> <span class="token punctuation">{</span>key<span class="token punctuation">:</span> np<span class="token punctuation">.</span>trim_zeros<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>row<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> key <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

    imu <span class="token operator">=</span> run<span class="token punctuation">[</span><span class="token string">'Yu'</span><span class="token punctuation">]</span> <span class="token comment"># degrees</span>
    tof <span class="token operator">=</span> run<span class="token punctuation">[</span><span class="token string">'D1'</span><span class="token punctuation">]</span> <span class="token comment"># mm</span>

    trials <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>imu<span class="token punctuation">)</span> <span class="token operator">//</span> self<span class="token punctuation">.</span>num_steps

    angle <span class="token operator">=</span> imu<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_steps<span class="token punctuation">,</span> trials<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span><span class="token punctuation">.</span>T
    distance <span class="token operator">=</span> tof<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_steps<span class="token punctuation">,</span> trials<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span><span class="token punctuation">.</span>T <span class="token operator">/</span> <span class="token number">1000</span> <span class="token comment"># mm -&gt; m</span>

    <span class="token comment"># Pass all but the last item in each column vector</span>
    <span class="token keyword">return</span> distance<span class="token punctuation">,</span> angle</code></pre><p>Note my use of a helper function, <code>await_end()</code> which uses <code>asyncio.sleep()</code> to wait for a BLE signal indicating the completion of the mapping command.</p><p>Then, in the absence of an automated ground truth, I used the following four marked arena locations from Lab 9 as known poses and ran the update step at each of them:</p><ol><li>(-3, -2) ft</li><li>(0, 3) ft</li><li>(5, -3) ft</li><li>(5, 3) ft</li></ol><h2>Results</h2><p>Below are the results for each marked location. The green dot in each plot is the ground truth, added manually in Python for each placement of the car. The blue dot is the belief after the Bayes update step.</p><h3>Marked Pose (-3, -2)</h3><img alt="Update step at (-3, -2)" src="/img/lab11_pose_a.png" width="1400" height="964"><p>The geometry of this part of the map seemed to yield really good results. I tried this location more than once and the belief was accurate each time. The arena is discretized, so the belief is rounded to some extent, but the result is nevertheless dead on.</p><h3>Marked Pose (0, 3)</h3><img alt="Update step at (0, 3)" src="/img/lab11_pose_b.png" width="1400" height="964"><p>This pose was slightly less accurate. The Bayes filter seemed to weigh the closer readings of the nearest walls more favorably, perhaps because the farther readings were more noisy.</p><h3>Marked Pose (5, -3)</h3><img alt="Update step at (5, -3)" src="/img/lab11_pose_c.png" width="1400" height="964"><p>This position was inconsistent. Shown here is a very good result, but I had two others that were slightly off. I think the inconsistency comes from the much more open nature of this part of the arena.</p><h3>Marked Pose (5, 3)</h3><img alt="Update step at (5, 3)" src="/img/lab11_pose_d.png" width="1400" height="964"><p>Lastly, this pose, similar to (0, 3), was a bit off the ground truth. Again, I think the dramatic difference between closer and farther walls might be the cause. There may also be a contribution from a discrepancy in the exact positions of the walls of the inner island feature, which, in the physical lab space, is actually a large cardboard box that's sligtly undersized and doesn't quite match the grid.</p><h3>Additional Tests</h3><p>As extra examples, I tried placing the car at the origin of the map and at (-1.5, -3.5). The results are shown below. The belief still matches the ground truth fairly well in these locations, which supports the robustness of the Bayes filter.</p><img alt="Update step at (0, 0)" src="/img/lab11_pose_origin.png" width="1400" height="964"> <img alt="Update step at (-1.5, -3.5)" src="/img/lab11_pose_extra.png" width="1400" height="967"><p>Overall, the Bayes filter seemed to fair much better in geometrically distinct locations. Some of the locations may look similar from the car's perspective due to the subtle symmetry built into the arena. The filter also seemed to prefer regions that are more closed off. Anytime that a significant portion of the measurements approached the limits of the ToF sensors' range—even in long-distance mode—the resulting noise caused minor inconsistencies or inaccuracies in the calculated beliefs.</p><p>As a last check, I also repeated the mapping process from <a href="/lab-9-mapping">Lab 9</a> using the data I collected during localization. The resulting map is shown below.</p><img alt="Arena map" src="/img/lab11_map.png" width="750" height="475"><h2>Demonstration</h2><p>The following video shows one of the update steps in action at (-3, -2).</p><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/IfA-VpMpp4s?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><h2>Conclusion</h2><p>This lab was an important step in bringing together many of the systems and principles we've been working toward all semester. In our last lab, we will use the localization process to plan and execute a path through the arena, so it's very encouraging to see such good results from the tests above.</p></article><footer class="mt-20 mb-10 sm:flex justify-between text-base/7 text-center text-gray-400 dark:text-gray-600"><p>MAE 4190 Fast Robots at Cornell University</p><p>© Spring 2024</p></footer></div></body></html>