<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Lab 5: Linear PID Control &ndash; MAE 4190 Fast Robots</title><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="noindex"><link rel="icon" type="image/png" href="/favicon.png"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="dns-prefetch" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Open+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/app.min.css?v=97e19db8"></head><body class="bg-white dark:bg-gray-950 text-gray-950 dark:text-gray-50 antialiased min-h-full overflow-x-hidden p-0 font-sans text-base leading-relaxed"><div class="mx-auto max-w-[45rem] px-4 sm:px-6"><nav class="flex justify-between mt-10 mb-16"><a class="block bg-brand-600 dark:bg-brand-400 px-2 text-xl sm:text-2xl font-mono font-bold tracking-tightest text-white dark:text-gray-950" href="/">MAE 4190 Fast Robots</a></nav><header class="my-6 space-y-5"><h1 class="text-5xl sm:text-6xl font-display font-bold tracking-tight text-gray-900 dark:text-gray-100">Lab 5: Linear PID Control</h1><div class="text-gray-500 dark:text-gray-400">March 12, 2024 | 1871 words</div></header><article class="mt-12 prose prose-lg dark:prose-invert prose-headings:font-black prose-headings:tracking-tight"><p>In <a href="https://fastrobotscornell.github.io/FastRobots/labs/Lab5.html">Lab 5</a>, I used ToF distance measurements to implement a PID controller that drives the car toward a wall and stops just short of crashing into it.</p><h2>Prelab</h2><p>I wanted to challenge myself a bit with this lab and decided to strive for full PID control of the car's position. To pull this off, I knew I would eventually be tuning three different gains, <mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg style="vertical-align: -0.65ex;" xmlns="http://www.w3.org/2000/svg" width="2.913ex" height="2.195ex" role="img" focusable="false" viewBox="0 -683 1287.7 970.2" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-1-TEX-I-1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path><path id="MJX-1-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D43E" xlink:href="#MJX-1-TEX-I-1D43E"></use></g><g data-mml-node="mi" transform="translate(882,-150) scale(0.707)"><use data-c="1D45D" xlink:href="#MJX-1-TEX-I-1D45D"></use></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>K</mi><mi>p</mi></msub></math></mjx-assistive-mml></mjx-container>, <mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="2.661ex" height="1.902ex" role="img" focusable="false" viewBox="0 -683 1176 840.8" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-2-TEX-I-1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path><path id="MJX-2-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D43E" xlink:href="#MJX-2-TEX-I-1D43E"></use></g><g data-mml-node="mi" transform="translate(882,-150) scale(0.707)"><use data-c="1D456" xlink:href="#MJX-2-TEX-I-1D456"></use></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>K</mi><mi>i</mi></msub></math></mjx-assistive-mml></mjx-container>, and <mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg style="vertical-align: -0.355ex;" xmlns="http://www.w3.org/2000/svg" width="2.94ex" height="1.901ex" role="img" focusable="false" viewBox="0 -683 1299.7 840.1" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-3-TEX-I-1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path><path id="MJX-3-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D43E" xlink:href="#MJX-3-TEX-I-1D43E"></use></g><g data-mml-node="mi" transform="translate(882,-150) scale(0.707)"><use data-c="1D451" xlink:href="#MJX-3-TEX-I-1D451"></use></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>K</mi><mi>d</mi></msub></math></mjx-assistive-mml></mjx-container>, so I started the lab by reorganizing my Artemis code and setting myself up for faster design iterations later on.</p><p>First, I separated the code for each major system and component into respective C++ header files.</p><ul><li><code>ble.hpp</code>: handles BLE connections and commands</li><li><code>imu.hpp</code>: processes IMU data and performs calculations</li><li><code>tof.hpp</code>: manages sensor juggling and processes ToF data</li><li><code>motors.hpp</code>: controls motors by translating speeds to PWM</li><li><code>cmd_types.h</code>: holds the <code>CommandTypes</code> enum</li><li><code>flags.h</code>: defines various boolean flags that control systems</li><li><code>util.hpp</code>: declares generic helper functions</li></ul><p>This left only the standard Arduino <code>setup()</code> and <code>loop()</code> in my core <code>artemis.ino</code> file. I did all this because I got tired of scrolling through a long wall of code to make changes. Normally, I would go one step further and move things into classes, but that's not so great for performance on microcontrollers. So no classes this time, but splitting things up for my sanity and letting the compiler stitch them back together is a good step forward.</p><p>Next, with a better structure in hand, I added several new commands to <code>ble.hpp</code> that control various aspects of the PID-related logic.</p><ul><li><code>SET_PID_POS_GAINS</code>: takes four floats—a speed factor <code>Sc</code>, and the positional PID gains <code>Kp</code>, <code>Ki</code>, and <code>Kd</code></li><li><code>ENABLE_MOTORS</code>: allow writing PWM values to the motors</li><li><code>DISABLE_MOTORS</code>: block motor PWM values</li><li><code>START_TOF_RANGING</code>: turn on the ranging function of the ToF sensors</li><li><code>STOP_TOF_RANGING</code>: turn off ToF ranging</li><li><code>START_PID_POS_CONTROL</code>: perform PID position control for a brief time</li><li><code>STOP_PID_POS_CONTROL</code>: end PID control and stop the motors if running</li><li><code>START_PID_POS_WITH_DATA</code>: perform PID control while saving all values</li><li><code>STOP_PID_POS_WITH_DATA</code>: end PID control</li><li><code>SEND_PID_DATA</code>: send recorded PID values over BLE</li></ul><p>Most of these commands simply flip boolean flags defined in <code>flags.h</code>, which are then used by various functions to conditionally perform actions. For example, <code>START_PID_POS_WITH_DATA</code> looks like this:</p><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// In handle_command():</span>
<span class="token keyword">case</span> START_PID_POS_WITH_DATA<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Only continue if not already active</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag_pid_pos <span class="token operator">&amp;&amp;</span> flag_record_tof<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// Remove all previously stored data</span>
    <span class="token function">clear_tof_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clear_pid_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get target distance from BLE command</span>
    success <span class="token operator">=</span> robot_cmd<span class="token punctuation">.</span><span class="token function">get_next_value</span><span class="token punctuation">(</span>pid_pos_target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// Set flags</span>
    flag_record_tof <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    flag_record_pid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    flag_pid_pos <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Once the PID maneuver is complete, I can stop everything again with <code>STOP_PID_POS_WITH_DATA</code>:</p><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// In handle_command():</span>
<span class="token keyword">case</span> STOP_PID_POS_WITH_DATA<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Only continue if still active</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag_pid_pos <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>flag_record_tof<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// Reset flags and values</span>
    flag_record_tof <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    flag_record_pid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    flag_pid_pos <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    pid_pos_target <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    pid_pos_start_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// Stop motors if still running</span>
    <span class="token function">stopMotors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>I can then send the recorded data using <code>SEND_PID_DATA</code>.</p><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// In handle_command():</span>
<span class="token keyword">case</span> SEND_PID_DATA<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint16_t</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> DATA_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tof_time_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

        tx_estring<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tx_estring<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"To:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tx_estring<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tof_time_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">1000.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tx_estring<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">",Do:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tx_estring<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>tof_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tx_estring<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">",Ti:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// PID data here</span>

        tx_characteristic<span class="token punctuation">.</span><span class="token function">writeValue</span><span class="token punctuation">(</span>tx_estring<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>On the Python side, the new commands allow a workflow as follows.</p><pre class="language-py"><code class="language-py"><span class="token comment"># Connect to the Artemis over Bluetooth</span>
nano <span class="token operator">=</span> Artemis<span class="token punctuation">(</span><span class="token punctuation">)</span>
nano<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Send the PID gains over BLE</span>
nano<span class="token punctuation">.</span>command<span class="token punctuation">(</span>CMD<span class="token punctuation">.</span>SET_PID_POS_GAINS<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>Sc<span class="token punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">{</span>Kp<span class="token punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">{</span>Ki<span class="token punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token punctuation">{</span>Kd<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

<span class="token comment"># Start ToF ranging</span>
nano<span class="token punctuation">.</span>command<span class="token punctuation">(</span>CMD<span class="token punctuation">.</span>START_TOF_RANGING<span class="token punctuation">)</span>

<span class="token comment"># Enable the motors</span>
nano<span class="token punctuation">.</span>command<span class="token punctuation">(</span>CMD<span class="token punctuation">.</span>ENABLE_MOTORS<span class="token punctuation">)</span>

<span class="token comment"># Start PID control, then wait for the car to maneuver</span>
nano<span class="token punctuation">.</span>command<span class="token punctuation">(</span>CMD<span class="token punctuation">.</span>START_PID_POS_WITH_DATA<span class="token punctuation">,</span> <span class="token string">'200'</span><span class="token punctuation">)</span> <span class="token comment"># target in mm</span>

<span class="token comment"># Stop PID control</span>
nano<span class="token punctuation">.</span>command<span class="token punctuation">(</span>CMD<span class="token punctuation">.</span>STOP_PID_POS_WITH_DATA<span class="token punctuation">)</span>

<span class="token comment"># Send PID data back to Python</span>
nano<span class="token punctuation">.</span>command<span class="token punctuation">(</span>CMD<span class="token punctuation">.</span>SEND_PID_DATA<span class="token punctuation">)</span>
nano<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Process data in nano.data...</span></code></pre><p>Should the BLE connection fail during a PID test, I have a failsafe mechanism that disables the motors and sensors immediately after the control loop.</p><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// In loop():</span>
<span class="token comment">// While BLE is connected</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>central<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// Stop everything when BLE disconnects</span>
flag_record_imu <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
flag_record_tof <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
flag_pid_pos <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token function">stopMotors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
TOF1<span class="token punctuation">.</span><span class="token function">stopRanging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
TOF2<span class="token punctuation">.</span><span class="token function">stopRanging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2>Tasks</h2><h3>Task 1: Frequency</h3><p>The ToF sampling frequency is dependent on the timing budget. Because the goal here is to make a fast PID controller that can stop the car from running into walls, I opted for a 20 ms timing budget, which is the fastest supported by our ToF sensors in long mode and yields a frequency of 50 Hz. To confirm this in practice, I printed times to the serial monitor as fast as possible while conditionally reading ToF data, similar to <a href="/lab-3-time-of-flight">Lab 3</a>.</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span>central<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Read ToF data when either flag is set</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag_tof_ranging <span class="token operator">||</span> flag_record_tof<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>TOF1<span class="token punctuation">.</span><span class="token function">checkForDataReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">record_tof_data</span><span class="token punctuation">(</span>TOF1<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Print times during ToF readings</span>
            Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token char">'ToF:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">micros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>TOF2<span class="token punctuation">.</span><span class="token function">checkForDataReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">record_tof_data</span><span class="token punctuation">(</span>TOF2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>After a few seconds of this, the serial monitor showed an approximate interval of 21.7 ms between ToF readings, corresponding to a frequency of <strong>46 Hz</strong>. That's just shy of the expected rate, and would likely be too slow for a PID controller.</p><p>Since the ToF sensors' short mode only supports distances up to roughly 1.3 m, I decided to switch to <em>long mode</em>, which supports up to 4 m. Together with a 20 ms timing budget, I knew the ToF sensors wouldn't be super accurate in this configuration, but they would be faster and reach pretty far.</p><h3>Task 2: PI Position Control</h3><p>A PID controller is a combination of proportional, integral, and derivative control terms to form the motor input function <mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="3.871ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 1711 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-4-TEX-I-1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-4-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-4-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-4-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D462" xlink:href="#MJX-4-TEX-I-1D462"></use></g><g data-mml-node="mo" transform="translate(572,0)"><use data-c="28" xlink:href="#MJX-4-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(961,0)"><use data-c="1D461" xlink:href="#MJX-4-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(1322,0)"><use data-c="29" xlink:href="#MJX-4-TEX-N-29"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>u</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></math></mjx-assistive-mml></mjx-container>, such that</p><p><mjx-container class="MathJax" jax="SVG" display="true" style="position: relative;"><svg style="vertical-align: -2.063ex;" xmlns="http://www.w3.org/2000/svg" width="39.805ex" height="5.526ex" role="img" focusable="false" viewBox="0 -1530.7 17593.8 2442.6" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-5-TEX-I-1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-5-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-5-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-5-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path id="MJX-5-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-5-TEX-I-1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path><path id="MJX-5-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path><path id="MJX-5-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-5-TEX-N-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path><path id="MJX-5-TEX-I-1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path><path id="MJX-5-TEX-LO-222B" d="M114 -798Q132 -824 165 -824H167Q195 -824 223 -764T275 -600T320 -391T362 -164Q365 -143 367 -133Q439 292 523 655T645 1127Q651 1145 655 1157T672 1201T699 1257T733 1306T777 1346T828 1360Q884 1360 912 1325T944 1245Q944 1220 932 1205T909 1186T887 1183Q866 1183 849 1198T832 1239Q832 1287 885 1296L882 1300Q879 1303 874 1307T866 1313Q851 1323 833 1323Q819 1323 807 1311T775 1255T736 1139T689 936T633 628Q574 293 510 -5T410 -437T355 -629Q278 -862 165 -862Q125 -862 92 -831T55 -746Q55 -711 74 -698T112 -685Q133 -685 150 -700T167 -741Q167 -789 114 -798Z"></path><path id="MJX-5-TEX-N-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path id="MJX-5-TEX-I-1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D462" xlink:href="#MJX-5-TEX-I-1D462"></use></g><g data-mml-node="mo" transform="translate(572,0)"><use data-c="28" xlink:href="#MJX-5-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(961,0)"><use data-c="1D461" xlink:href="#MJX-5-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(1322,0)"><use data-c="29" xlink:href="#MJX-5-TEX-N-29"></use></g><g data-mml-node="mo" transform="translate(1988.8,0)"><use data-c="3D" xlink:href="#MJX-5-TEX-N-3D"></use></g><g data-mml-node="msub" transform="translate(3044.6,0)"><g data-mml-node="mi"><use data-c="1D43E" xlink:href="#MJX-5-TEX-I-1D43E"></use></g><g data-mml-node="mi" transform="translate(882,-150) scale(0.707)"><use data-c="1D45D" xlink:href="#MJX-5-TEX-I-1D45D"></use></g></g><g data-mml-node="mi" transform="translate(4332.2,0)"><use data-c="1D452" xlink:href="#MJX-5-TEX-I-1D452"></use></g><g data-mml-node="mo" transform="translate(4798.2,0)"><use data-c="28" xlink:href="#MJX-5-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(5187.2,0)"><use data-c="1D461" xlink:href="#MJX-5-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(5548.2,0)"><use data-c="29" xlink:href="#MJX-5-TEX-N-29"></use></g><g data-mml-node="mo" transform="translate(6159.5,0)"><use data-c="2B" xlink:href="#MJX-5-TEX-N-2B"></use></g><g data-mml-node="msub" transform="translate(7159.7,0)"><g data-mml-node="mi"><use data-c="1D43E" xlink:href="#MJX-5-TEX-I-1D43E"></use></g><g data-mml-node="mi" transform="translate(882,-150) scale(0.707)"><use data-c="1D456" xlink:href="#MJX-5-TEX-I-1D456"></use></g></g><g data-mml-node="msubsup" transform="translate(8502.3,0)"><g data-mml-node="mo" transform="translate(0 1)"><use data-c="222B" xlink:href="#MJX-5-TEX-LO-222B"></use></g><g data-mml-node="mi" transform="translate(1046.4,1088.1) scale(0.707)"><use data-c="1D461" xlink:href="#MJX-5-TEX-I-1D461"></use></g><g data-mml-node="mn" transform="translate(589,-896.4) scale(0.707)"><use data-c="30" xlink:href="#MJX-5-TEX-N-30"></use></g></g><g data-mml-node="mi" transform="translate(10020.6,0)"><use data-c="1D452" xlink:href="#MJX-5-TEX-I-1D452"></use></g><g data-mml-node="mo" transform="translate(10486.6,0)"><use data-c="28" xlink:href="#MJX-5-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(10875.6,0)"><use data-c="1D461" xlink:href="#MJX-5-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(11236.6,0)"><use data-c="29" xlink:href="#MJX-5-TEX-N-29"></use></g><g data-mml-node="mi" transform="translate(11625.6,0)"><use data-c="1D451" xlink:href="#MJX-5-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(12145.6,0)"><use data-c="1D461" xlink:href="#MJX-5-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(12728.8,0)"><use data-c="2B" xlink:href="#MJX-5-TEX-N-2B"></use></g><g data-mml-node="msub" transform="translate(13729.1,0)"><g data-mml-node="mi"><use data-c="1D43E" xlink:href="#MJX-5-TEX-I-1D43E"></use></g><g data-mml-node="mi" transform="translate(882,-150) scale(0.707)"><use data-c="1D451" xlink:href="#MJX-5-TEX-I-1D451"></use></g></g><g data-mml-node="mfrac" transform="translate(15028.8,0)"><g data-mml-node="mrow" transform="translate(220,710)"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-5-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(520,0)"><use data-c="1D452" xlink:href="#MJX-5-TEX-I-1D452"></use></g><g data-mml-node="mo" transform="translate(986,0)"><use data-c="28" xlink:href="#MJX-5-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(1375,0)"><use data-c="1D461" xlink:href="#MJX-5-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(1736,0)"><use data-c="29" xlink:href="#MJX-5-TEX-N-29"></use></g></g><g data-mml-node="mrow" transform="translate(842,-686)"><g data-mml-node="mi"><use data-c="1D451" xlink:href="#MJX-5-TEX-I-1D451"></use></g><g data-mml-node="mi" transform="translate(520,0)"><use data-c="1D461" xlink:href="#MJX-5-TEX-I-1D461"></use></g></g><rect width="2325" height="60" x="120" y="220"></rect></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>u</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>K</mi><mi>p</mi></msub><mi>e</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mi>K</mi><mi>i</mi></msub><msubsup><mo data-mjx-texclass="OP">∫</mo><mn>0</mn><mi>t</mi></msubsup><mi>e</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mi>d</mi><mi>t</mi><mo>+</mo><msub><mi>K</mi><mi>d</mi></msub><mfrac><mrow><mi>d</mi><mi>e</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></math></mjx-assistive-mml></mjx-container></p><p>where <mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="3.631ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 1605 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-6-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-6-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-6-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-6-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D452" xlink:href="#MJX-6-TEX-I-1D452"></use></g><g data-mml-node="mo" transform="translate(466,0)"><use data-c="28" xlink:href="#MJX-6-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(855,0)"><use data-c="1D461" xlink:href="#MJX-6-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(1216,0)"><use data-c="29" xlink:href="#MJX-6-TEX-N-29"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>e</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></math></mjx-assistive-mml></mjx-container> here is the error between the current position (as measured by ToF sensors) and the desired target position (set point).</p><p>A P controller is a good start but will often experience considerable steady state error. A PI controller attempts to fix this by pushing the motors more and more until the error is eliminated. A PID controller improves upon the situation even further by damping the motor input in response to rapid changes in sensor readings, such as when the car gets close to the wall. Generally, a PID controller is a classic mechanism and worth exploring.</p><p>I started building the PID controller by focusing on the P (proportional) term. For <a href="/lab-4-motors-and-open-loop-control">Lab 4</a>, I had already written a function, <code>driveMotors()</code>, that takes motor speeds in percentages (between 0 and 100) and translates them to PWM values. While implementing the proportional controller, I therefore chose values of <mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg style="vertical-align: -0.65ex;" xmlns="http://www.w3.org/2000/svg" width="2.913ex" height="2.195ex" role="img" focusable="false" viewBox="0 -683 1287.7 970.2" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-7-TEX-I-1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path><path id="MJX-7-TEX-I-1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><use data-c="1D43E" xlink:href="#MJX-7-TEX-I-1D43E"></use></g><g data-mml-node="mi" transform="translate(882,-150) scale(0.707)"><use data-c="1D45D" xlink:href="#MJX-7-TEX-I-1D45D"></use></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>K</mi><mi>p</mi></msub></math></mjx-assistive-mml></mjx-container> on the order of <strong>0.05</strong>. This way, an error of roughly 2000 mm would yield 100% speed, while an error of 100 mm would yield only 5% speed, which both seem reasonable given the goal of 300 mm from 2–4 m distance.</p><p>To implement proportional control, I added a <code>pid.hpp</code> C++ header and a <code>pid_pos_control()</code> function.</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">float</span> pid_time_data<span class="token punctuation">[</span>DATA_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> pid_distance_data<span class="token punctuation">[</span>DATA_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> pid_p_data<span class="token punctuation">[</span>DATA_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">uint16_t</span> pid_data_i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// Set by BLE command</span>
<span class="token keyword">float</span> Sc_pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> Kp_pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> pid_pos_target <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">float</span> current_pid_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> current_error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> P_term <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> speed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">pid_pos_control</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Update current time</span>
    current_pid_time <span class="token operator">=</span> <span class="token function">micros</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1.e6</span><span class="token punctuation">;</span> <span class="token comment">// secs</span>

    <span class="token comment">// Determine error from most recent position and set point</span>
    current_error <span class="token operator">=</span> current_tof_reading <span class="token operator">-</span> pid_pos_target<span class="token punctuation">;</span>

    <span class="token comment">// Calculate P term</span>
    P_term <span class="token operator">=</span> Kp_pos <span class="token operator">*</span> current_error<span class="token punctuation">;</span>

    speed <span class="token operator">=</span> Sc_pos <span class="token operator">*</span> P_term<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag_record_pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pid_time_data<span class="token punctuation">[</span>pid_data_i<span class="token punctuation">]</span> <span class="token operator">=</span> current_pid_time<span class="token punctuation">;</span>
        pid_distance_data<span class="token punctuation">[</span>pid_data_i<span class="token punctuation">]</span> <span class="token operator">=</span> current_tof_reading<span class="token punctuation">;</span>
        pid_p_data<span class="token punctuation">[</span>pid_data_i<span class="token punctuation">]</span> <span class="token operator">=</span> P_term<span class="token punctuation">;</span>

        pid_data_i<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token comment">// Out of memory</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid_data_i <span class="token operator">&gt;=</span> DATA_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            flag_record_tof <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            flag_record_pid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag_enable_motors<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// Only drive motors if the speed meets the minimum threshold</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MOTOR_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">stopMotors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">driveMotors</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>I then called the PID function in the BLE control loop.</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span>central<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Read ToF data</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Perform PID</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag_tof_ranging <span class="token operator">&amp;&amp;</span> flag_pid_pos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pid_pos_control</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Setting the speed scale <code>Sc</code> to 0.5 for half speed and the proportional gain <code>Kp</code> to <strong>0.05</strong> as planned, I tested the P controller for a set point of 300 mm.</p><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/IQHpx8LumsE?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><img alt="P control at 50% speed" src="/img/lab5_p_control.png" width="1000" height="600"><p>To add the I (integral) term, I kept track of the previous PID loop time to calculate <code>dt</code> and use it to sum error over all time.</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">float</span> pid_i_data<span class="token punctuation">[</span>DATA_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Set by BLE command</span>
<span class="token keyword">float</span> Ki_pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">float</span> pid_dt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> last_pid_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> current_pid_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> error_integral <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> I_term <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">pid_pos_control</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Calculate dt</span>
    pid_dt <span class="token operator">=</span> current_pid_time <span class="token operator">-</span> last_pid_time<span class="token punctuation">;</span>
    last_pid_time <span class="token operator">=</span> current_pid_time<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Integrate error</span>
    error_integral <span class="token operator">=</span> error_integral <span class="token operator">+</span> current_error <span class="token operator">*</span> pid_dt<span class="token punctuation">;</span>

    I_term <span class="token operator">=</span> Ki_pos <span class="token operator">*</span> error_integral<span class="token punctuation">;</span>

    speed <span class="token operator">=</span> Sc_pos <span class="token operator">*</span> <span class="token punctuation">(</span>P_term <span class="token operator">+</span> I_term<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag_record_pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        pid_i_data<span class="token punctuation">[</span>pid_data_i<span class="token punctuation">]</span> <span class="token operator">=</span> I_term<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre><p>After playing around with the integral gain <code>Ki</code>, I settled on <strong>0.007</strong> and tested the new PI controller at the same set point of 300 mm.</p><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/i8DDJRQ6-B8?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><img alt="PI control at 50% speed" src="/img/lab5_pi_control.png" width="1000" height="600"><h3>Task 3: PID Loop Rate</h3><p>Before continuing on to the D (derivative) term, I needed to know how fast the PID controller runs when decoupled from the ToF sensors. To that end, I had the BLE control loop print times to the serial monitor as fast as possible.</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span>central<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Read ToF data</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Perform PID</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag_tof_ranging <span class="token operator">&amp;&amp;</span> flag_pid_pos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Print times as fast as PID will run</span>
        Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token char">'PID:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">micros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">pid_pos_control</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>From this, I found that the PID control loop interval was 3.57 ms, which is a frequency of about <strong>280 Hz</strong>, six times faster than the rate of ToF readings. Smooth derivative control would therefore require extrapolation to bridge the gaps in distance measurements.</p><h3>Task 4: Distance Extrapolation</h3><p>To extrapolate distance, I first added global variables to store the last two ToF measurements. From these, I could then calculate the slope between them, then multiply that by the time elapsed since the most recent measurement.</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">uint16_t</span> current_tof_reading <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">uint16_t</span> last_tof_reading <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> current_tof_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> last_tof_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> tof_slope <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">float</span> tof_dt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> tof_distance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">record_tof_data</span><span class="token punctuation">(</span>SFEVL53L1X <span class="token operator">&amp;</span>TOF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    last_tof_reading <span class="token operator">=</span> tof_reading<span class="token punctuation">;</span>
    last_tof_time <span class="token operator">=</span> tof_time<span class="token punctuation">;</span>

    tof_reading <span class="token operator">=</span> TOF<span class="token punctuation">.</span><span class="token function">getDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tof_time <span class="token operator">=</span> <span class="token function">micros</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1.e6</span><span class="token punctuation">;</span> <span class="token comment">// secs</span>

    tof_slope <span class="token operator">=</span> <span class="token punctuation">(</span>tof_reading <span class="token operator">-</span> last_tof_reading<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>tof_time <span class="token operator">-</span> last_tof_time<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pid_pos_control</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Calculate dt for ToF sensor readings</span>
    tof_dt <span class="token operator">=</span> current_pid_time <span class="token operator">-</span> current_tof_time<span class="token punctuation">;</span> <span class="token comment">// secs</span>
    tof_distance <span class="token operator">=</span> tof_slope <span class="token operator">*</span> tof_dt <span class="token operator">+</span> current_tof_reading<span class="token punctuation">;</span>

    <span class="token comment">// Find error from extrapolated distance</span>
    current_error <span class="token operator">=</span> tof_distance <span class="token operator">-</span> pid_pos_target<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre><p>The effect of the extrapolation is a relative smoothing out of the rather step-like data generated by intermittent ToF readings. I say relative because the extrapolation gets its "prediction" wrong any time there are sudden changes in direction of the data, thereby causing little spikes.</p><img alt="Distance extrapolation" src="/img/lab5_extrapolation.png" width="1000" height="400"><h3>Task 5: PID Control</h3><p>With distance extrapolation in place, I modified <code>pid_pos_control()</code> to add the derivative term to the PID controller by finding the change in error since the last step and dividing by <code>dt</code>. I then also added a strong low-pass filter (LPF) because the ToF data is quite noisy in long mode and the resulting derivative is highly reactive, amplifying the spiky behavior seen in the extrapolation. The LPF helps to calm the derivative control down to more reasonable values.</p><pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">D_LPF_ALPHA</span> <span class="token expression"><span class="token number">0.015</span></span></span>

<span class="token keyword">float</span> pid_d_data<span class="token punctuation">[</span>DATA_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> pid_df_data<span class="token punctuation">[</span>DATA_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Set by BLE command</span>
<span class="token keyword">float</span> Kd_pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">float</span> last_error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> D_term <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> filtered_D_term <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> last_filtered_D_term <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">pid_pos_control</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Differentiate error</span>
    D_term <span class="token operator">=</span> Kd_pos <span class="token operator">*</span> <span class="token punctuation">(</span>current_error <span class="token operator">-</span> last_error<span class="token punctuation">)</span> <span class="token operator">/</span> pid_dt<span class="token punctuation">;</span>
    last_error <span class="token operator">=</span> current_error<span class="token punctuation">;</span>

    filtered_D_term <span class="token operator">=</span> D_LPF_ALPHA <span class="token operator">*</span> D_term <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>D_LPF_ALPHA<span class="token punctuation">)</span> <span class="token operator">*</span> last_filtered_D_term<span class="token punctuation">;</span>
    last_filtered_D_term <span class="token operator">=</span> filtered_D_term<span class="token punctuation">;</span>

    speed <span class="token operator">=</span> Sc_pos <span class="token operator">*</span> <span class="token punctuation">(</span>P_term <span class="token operator">+</span> I_term <span class="token operator">+</span> filtered_D_term<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag_record_pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        pid_distance_data<span class="token punctuation">[</span>pid_data_i<span class="token punctuation">]</span> <span class="token operator">=</span> tof_distance<span class="token punctuation">;</span>
        pid_d_data<span class="token punctuation">[</span>pid_data_i<span class="token punctuation">]</span> <span class="token operator">=</span> D_term<span class="token punctuation">;</span>
        pid_df_data<span class="token punctuation">[</span>pid_data_i<span class="token punctuation">]</span> <span class="token operator">=</span> filtered_D_term<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>After some tuning, I chose a <code>Kd</code> of <strong>0.02</strong> and tested the finished PID controller at 50% speed for the same set point of 300 mm.</p><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/ba0JUGRG4uk?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><img alt="PID control at 50% speed" src="/img/lab5_pid_control_50.png" width="1000" height="600"><p>I then bumped the speed up to 80% and ran the test again.</p><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/u3gH97OUnyA?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><img alt="PID control at 80% speed" src="/img/lab5_pid_control_80.png" width="1000" height="600"><p>Lastly, I set the speed to 100% for a full steam attempt.</p><p><iframe class="w-full aspect-video outline-none border-none" src="https://www.youtube-nocookie.com/embed/2w5BGJE2XhI?rel=0" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></p><img alt="PID control at 100% speed" src="/img/lab5_pid_control_100.png" width="1000" height="600"><p>As I ramped up the speed of the car, I noticed that traction between the wheels and my hardwood floor became an issue when the car tried to stop or reverse directions near the set point. The result was something of a tilt motion for which the car did not have a correction mechanism. Orientation control will hopefully account for this in the future, but I also note that doing this sort of experimentation on carpet may be better.</p><p>From these tests, I decided that derivative kick wasn't really an issue. Though kick is worth considering, the effects of the LPF were already so significant that there was little point in pursuing a treatment for kick on top of it. The plot below shows the LPF in action. Note the green and red curves.</p><img alt="PID filtered D term" src="/img/lab5_pid_filtered.png" width="1000" height="400"><p>Along similar lines, I let the motors coast when the input <mjx-container class="MathJax" jax="SVG" style="position: relative;"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="3.871ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 1711 1000" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true"><defs><path id="MJX-8-TEX-I-1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-8-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-8-TEX-I-1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path><path id="MJX-8-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D462" xlink:href="#MJX-8-TEX-I-1D462"></use></g><g data-mml-node="mo" transform="translate(572,0)"><use data-c="28" xlink:href="#MJX-8-TEX-N-28"></use></g><g data-mml-node="mi" transform="translate(961,0)"><use data-c="1D461" xlink:href="#MJX-8-TEX-I-1D461"></use></g><g data-mml-node="mo" transform="translate(1322,0)"><use data-c="29" xlink:href="#MJX-8-TEX-N-29"></use></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>u</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></math></mjx-assistive-mml></mjx-container> was zero, rather than actively braking them, because the controller should be able to deal with overshoot well enough that the time complexities of braking aren't really worth introducing. When braking, simply setting all pins to high for one PID iteration isn't enough. The brake has to be "held down" for a short while to induce enough torque to stop the motors. That act effectively blocks the PID control loop, which I wanted to avoid if at all possible.</p><h3>Task 6: Speed</h3><p>At full speed, my car is able to close a 2.5 m distance to the wall in 1.5 seconds. The maximum speed during this maneuver is roughly <strong>2 m/s</strong>, found from the highest rate of change of the car's position over its runtime. The speed is shown as a slope on the position plot below.</p><img alt="Position with slope" src="/img/lab5_position.jpg" width="1000" height="400"><h3>Optional 5000-Level: Wind-Up Protection</h3><p>While tuning the integral term of the PID controller, I quickly noticed that integrator wind-up would be a problem. The plot below shows an example of how the integral term can vastly outscale the proportional term.</p><img alt="Integrator wind-up" src="/img/lab5_wind_up.png" width="1000" height="400"><p>This happens because errors are summed over time, and can self-perpetuate a larger and larger running integration, quickly ballooning to unreasonable values. Once the error integration has built up, it takes equally large values of the opposite sign to reduce the sum again.</p><p>To prevent this kind of wind-up, I added a constraint onto the error integration so it cannot exceed 300% speed in either direction.</p><pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INTEGRAL_THRESHOLD</span> <span class="token expression"><span class="token number">300</span></span></span>

<span class="token keyword">void</span> <span class="token function">pid_pos_control</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Constrained integral of error</span>
    error_integral <span class="token operator">=</span> <span class="token function">constrain</span><span class="token punctuation">(</span>
        error_integral <span class="token operator">+</span> current_error <span class="token operator">*</span> pid_dt<span class="token punctuation">,</span>
        <span class="token operator">-</span>INTEGRAL_THRESHOLD<span class="token punctuation">,</span> INTEGRAL_THRESHOLD
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre><p>With the wind-up heavily constrained, the integral term contributes only a little to the overall PID output, as can be seen in the earlier 100% speed PID test, shown again here.</p><img alt="PID control at 100% speed" src="/img/lab5_pid_control_100.png" width="1000" height="600"><p>This is preferable to letting the controller spiral out of control and send the car flying across the room at the slightest touch of error.</p><h2>Conclusion</h2><p>This lab made me appreciate PID controllers more. I have studied them in past courses, but building one from scratch and then tuning it for a real-world target scenario was educational. This process did not come without issues, however.</p><p>For one thing, I discovered that my approach to storing time data as microseconds, then dividing those values by <code>1e6</code> upon sending them over Bluetooth causes several odd rounding problems in the <code>EString</code> class. I have not yet had time to investigate this further, but I suspect there may be something wrong with how floats are encoded into BLE messages.</p><p>Another issue I faced is that I had trouble extrapolating the distance values at first because I wasn't clearing the ToF ranging interrupts between readings. I had seen elsewhere that starting and stopping the ranging with every measurement wasn't completely necessary, but apparently it does have some odd side effects. In my case, the ToF sensors would repeat readings several times when the interrupt wasn't cleared. So when I tried to calculate slopes between recent values, I kept getting zeros.</p><p>It'll be interesting to add orientation soon. I can tell the car needs it. The motors, gearboxes, and even the wheels are all too inconsistent to maintain a true course for very long.</p></article><footer class="mt-20 mb-10 sm:flex justify-between text-base/7 text-center text-gray-400 dark:text-gray-600"><p>MAE 4190 Fast Robots at Cornell University</p><p>© Spring 2024</p></footer></div></body></html>